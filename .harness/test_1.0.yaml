template:
  name: build-and-push-docker
  type: Pipeline
  projectIdentifier: default_project
  orgIdentifier: default
  spec:
    properties:
      ci:
        codebase:
          connectorRef: githubfrozenwings
          repoName: harness-gitops-workshop
          build: <+input>
    stages:
      - stage:
          name: ci-stage
          identifier: cistage
          description: ""
          type: CI
          spec:
            cloneCodebase: true
            platform:
              os: MacOS
              arch: Arm64
            runtime:
              type: Docker
              spec: {}
            execution:
              steps:
                - step:
                    type: Run
                    name: Run OWASP Tests
                    identifier: Run_OWASP_Tests
                    spec:
                      shell: Sh
                      command: |-
                        echo "Running OWASP tests..."
                        sleep 2
                        echo "OWASP tests passed!"
                - step:
                    type: BuildAndPushDockerRegistry
                    name: BuildAndPushDockerRegistry_1
                    identifier: BuildAndPushDockerRegistry_1
                    spec:
                      connectorRef: dockerhub
                      repo: frozenwings/harness-gitops-workshop
                      tags:
                        - <+pipeline.variables.imageTag>
                      dockerfile: apps/podinfo/Dockerfile
                      context: apps/podinfo
                - step:
                    type: Run
                    name: Echo
                    identifier: Echo
                    spec:
                      shell: Sh
                      command: echo "Build and push ${imageTag} success"
                      envVariables:
                        imageTag: <+pipeline.variables.imageTag>
          delegateSelectors:
            - lxy-delegate
      - parallel:
          - stage:
              name: tt
              identifier: tt
              description: ""
              type: CI
              spec:
                cloneCodebase: true
                platform:
                  os: Linux
                  arch: Amd64
                runtime:
                  type: Docker
                  spec: {}
                execution:
                  steps:
                    - step:
                        type: Run
                        name: Run_1
                        identifier: Run_1
                        spec: {}
          - stage:
              name: ff
              identifier: ff
              description: ""
              type: CI
              spec:
                cloneCodebase: true
                execution:
                  steps:
                    - parallel:
                        - step:
                            type: Run
                            name: Run_1
                            identifier: Run_1
                            spec:
                              connectorRef: dockerhub
                              image: <+input>
                              shell: Bash
                              privileged: false
                        - step:
                            type: BuildAndPushGCR
                            name: BuildAndPushGCR_1
                            identifier: BuildAndPushGCR_1
                            spec: {}
                        - step:
                            type: BuildAndPushGAR
                            name: BuildAndPushGAR_1
                            identifier: BuildAndPushGAR_1
                            spec: {}
                    - parallel:
                        - step:
                            type: Background
                            name: Background_1
                            identifier: Background_1
                            spec: {}
                        - step:
                            type: Run
                            name: Run_2
                            identifier: Run_2
                            spec: {}
                platform:
                  os: Linux
                  arch: Arm64
                runtime:
                  type: Docker
                  spec: {}
    variables:
      - name: imageTag
        type: String
        description: ""
        required: false
        value: <+input>
  identifier: test
  versionLabel: "1.0"
  tags: {}
